

- name: Load vars from organisation.yml
  include_vars:
    file: '/var/lib/awx/projects/clients/{{ member_id }}/organisation.yml'

# ^ Might be redundant

- name: Install tower dep
  delegate_to: 127.0.0.1
  pip:
      name: ansible-tower-cli

- name: Add tower host to organisations inventory
  delegate_to: 127.0.0.1
  tower_host:
    name: "matrix.{{ matrix_domain }}"
    description: "{{ matrix_domain }} Matrix Server"
    inventory: "{{ member_id }} Inventory"
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes
  register: fs_host

- name: Create 'matrix_servers' group
  delegate_to: 127.0.0.1
  tower_group:
    name: matrix_servers
    description: "Matrix servers to deploy/configure."
    inventory: "{{ member_id }} Inventory"
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes
  register: fs_group

- name: Configure awx-cli 1
  delegate_to: 127.0.0.1
  shell: awx-cli config username "{{ tower_username }}"

- name: Configure awx-cli 2
  delegate_to: 127.0.0.1
  shell: awx-cli config password "{{ tower_password }}"

- name: Configure awx-cli 3
  delegate_to: 127.0.0.1
  shell: awx-cli config host "{{ tower_host }}"

- name: Associate host group
  delegate_to: 127.0.0.1
  shell: awx-cli host associate --host "{{ fs_host.id }}" --group "{{ fs_group.id }}"

- name: Disallow user account to use the 'Provision a New Server' job_template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ subscription_id }} - 00 - Provision a New Server"
    role: execute
    state: absent
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to read the 'Provision a New Server' job_template/history
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ subscription_id }} - 00 - Provision a New Server"
    role: read
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Deploy a New Server' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 0 - Deploy a New Server"
    description: "Creates a new matrix service with Spantaleev's playbooks"
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: "setup-all,start"
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Deploy a New Server' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 0 - Deploy a New Server"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Start/Restart all Services' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 0 - Start/Restart all Services"
    description: "Starts or restarts all services on the server."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: start
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Start/Restart all Services' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 0 - Start/Restart all Services"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Stop all Services' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 0 - Stop all Services"
    description: "Stops all services on the server."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: stop
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Stop all Services' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 0 - Stop all Services"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Save new 'Configure Element' survey.json to the AWX tower, template
  delegate_to: 127.0.0.1
  template:
    src: 'inventory/surveys/configure_element.json.j2'
    dest: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_element.json'

- name: Create 'Configure Element' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 1 - Configure Element"
    description: "Configure Element client via survey."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: "start,setup-client-element"
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    survey_enabled: true
    survey_spec: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_element.json') }}"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Configure Element' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 1 - Configure Element"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Save initial 'Configure Synapse' survey.json to the AWX tower
  delegate_to: 127.0.0.1
  copy:
    src: ./inventory/surveys/configure_synapse.json
    dest: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_synapse.json'
    mode: 0644

- name: Create 'Configure Synapse' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 1 - Configure Synapse"
    description: "Configure Synapse (homeserver) settings."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: "start,setup-synapse"
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    survey_enabled: true
    survey_spec: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_synapse.json') }}"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Configure Synapse' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 1 - Configure Synapse"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Save initial 'Configure Jitsi' survey.json to the AWX tower
  delegate_to: 127.0.0.1
  copy:
    src: ./inventory/surveys/configure_jitsi.json
    dest: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_jitsi.json'
    mode: 0644

- name: Create 'Configure Jitsi' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 1 - Configure Jitsi"
    description: "Configure Jitsi conferencing settings."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: "start,setup-jitsi"
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    survey_enabled: true
    survey_spec: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_jitsi.json') }}"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Configure Jitsi' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 1 - Configure Jitsi"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Save initial 'Configure Ma1sd' survey.json to the AWX tower
  delegate_to: 127.0.0.1
  copy:
    src: ./inventory/surveys/configure_ma1sd.json
    dest: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_ma1sd.json'
    mode: 0644

- name: Create 'Configure Ma1sd' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 1 - Configure Ma1sd"
    description: "Configure Ma1sd conferencing settings."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    job_tags: "start,setup-ma1sd"
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - ChatOasis testing SSH"
    survey_enabled: true
    survey_spec: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_ma1sd.json') }}"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Configure Ma1sd' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 1 - Configure Ma1sd"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Save initial 'Create User' survey.json to the AWX tower
  delegate_to: 127.0.0.1
  copy:
    src: ./inventory/surveys/create_user.json
    dest: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/create_user.json'
    mode: 0644

- name: Create 'Create User' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 2 - Create User"
    description: "Create a new user account and choose if it has admin access."
    extra_vars_path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.yml'
    job_type: run
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - AWX Playbooks"
    playbook: create_user.yml
    survey_enabled: true
    survey_spec: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/create_user.json') }}"
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Create User' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 2 - Create User"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Deactivate User' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 2 - Deactivate User"
    description: "Deactivates a users account."
    job_type: run
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - AWX Playbooks"
    playbook: deactivate_user.yml
#    become_enabled: yes
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Deactivate User' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 2 - Deactivate User"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Query User' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 2 - Query User"
    description: "Provide client/IP information about a specific user."
    job_type: run
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - AWX Playbooks"
    playbook: query_user.yml
#    become_enabled: yes
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Query User' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 2 - Query User"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Remove Room From Directory' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 2 - Remove Room From Directory"
    description: "Remove a room from the homeservers public directory."
    job_type: run
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - AWX Playbooks"
    playbook: remove_room_from_directory.yml
#    become_enabled: yes
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Remove Room From Directory' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 2 - Remove Room From Directory"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Create 'Reset Password' job template
  delegate_to: 127.0.0.1
  tower_job_template:
    name: "{{ matrix_domain }} - 2 - Reset Password"
    description: "Resets a users password."
    job_type: run
    inventory: "{{ member_id }} Inventory"
    project: "{{ member_id }} - AWX Playbooks"
    playbook: reset_password.yml
#    become_enabled: yes
    state: present
    verbosity: 1
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

- name: Allow user account to use 'Reset Password' job template
  delegate_to: 127.0.0.1
  tower_role:
    user: "{{ member_id }}"
    job_template: "{{ matrix_domain }} - 2 - Reset Password"
    role: execute
    state: present
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"
    validate_certs: yes

